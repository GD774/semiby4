<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gdu.semiby4.mapper.UserMapper">

  <resultMap type="UserDto" id="UserMap">
    <id      property="userNo"       column="USER_NO" />
    <result  property="userId"       column="USER_ID"/>
    <result  property="role"         column="ROLE" />
    <result  property="pw"           column="PW"/>
    <result  property="email"        column="EMAIL" />
    <result  property="name"         column="NAME" />
    <result  property="gender"       column="GENDER"/>
    <result  property="mobile"       column="MOBILE" />
    <result  property="pwModifyDt"   column="PW_MODIFY_DT" />
    <result  property="signupDt"     column="SIGNUP_DT" />
  </resultMap>

  <select id="getUserByMap"
          parameterType="Map"
          resultType="UserDto">
    SELECT USER_NO, USER_ID, ROLE, PW, EMAIL, NAME, GENDER, MOBILE, PW_MODIFY_DT, SIGNUP_DT
      FROM USER_T
    <where>
      <if test="email!=null">EMAIL = #{email}</if>
      <if test="pw!=null">AND PW = #{pw}</if>
    </where>
  </select>

  <insert id="insertUser"
          parameterType="UserDto">
    INSERT INTO USER_T (
      USER_NO
    , USER_ID
    , ROLE
    , PW
    , EMAIL
    , NAME
    , GENDER
    , MOBILE
    , PW_MODIFY_DT
    , SIGNUP_DT
    ) VALUES (
        USER_SEQ.NEXTVAL
      , 0
      , #{userId}
      , #{pw}
      , #{email}
      , #{name}
      , #{gender}
      , #{mobile}
      , CURRENT_DATE
      , CURRENT_DATE
    )
  </insert>

  <delete id="deleteUser">
    DELETE
      FROM USER_T
     WHERE USER_NO = #{userNo}
  </delete>
  
  <select id="adminUserList2"
          resultMap="UserMap">
    SELECT U.*, 
          (SELECT COUNT(*) FROM BOARD_T WHERE USER_NO = U.USER_NO) AS BOARD_CNT,
          (SELECT COUNT(*) FROM COMMENT_T WHERE USER_NO = U.USER_NO) AS COMMENT_CNT,      
      FROM USER_T U 
     ORDER BY USER_NO DESC
  </select>

  <select id="getuserInfo"
          resultMap="UserMap">
    SELECT * FROM USER_T
     WHERE USER_ID = SUBSTR(#{email}, 1, INSTR(#{email}, '@') - 1)
  </select>

  <select id="adminUserList" resultMap="UserMap">
    SELECT * 
      FROM (SELECT * 
              FROM USER_T 
             ORDER BY USER_NO DESC) 
      <![CDATA[
      WHERE ROWNUM <=5 
      ]]>
  </select>
  
  <update id="dropUser">
    UPDATE USER_T
       SET ROLE = 2 
     WHERE USER_ID = #{userId}
  </update>
  
</mapper>
